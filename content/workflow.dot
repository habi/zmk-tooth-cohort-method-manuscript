# compile to png with
# dot workflow.dot -Tpng -o workflow.png
digraph Workflow {

    splines=ortho;
    bgcolor=transparent;
    #newrank=true; # https://stackoverflow.com/a/18410951/323100

    edge [arrowhead = o];
    node [shape=box, style="rounded,filled"];

    prep [label="Sample preparation"];
    
    subgraph cluster_uct {
        label = "Micro-CT";
        color=grey;
        penwidth=2;
        
        uct [label="Tomographic\nScanning"];
        reco [label="Reconstruction"];
        
        uct -> reco;
        }
    prep -> uct;
    
    subgraph cluster_analysis {
        label = "Analysis notebook";
        color=grey;
        penwidth=2;
        
        dask [label="Conversion to zarr"];
        log [label="Read parameters\nfrom log files"]; 
        bmp [label="Check scans"];
        
        reco -> dask -> crop -> mid;        
        reco -> log[constraint=false];
        reco -> bmp[constraint=false];
        
        {rank=same;dask;log;bmp}
        
        crop [label="Extraction of tooth\nfrom large tomographic\ndatasets"];
        crop -> pulpa;
        mip  [label="Maximum intensity\nprojections"];        
        crop -> mip;
        apex [label="Isolation of apex"];
        mid  [label="Middle images"];        
        crop -> apex
        apex -> mip [constraint=false];
        apex -> mid [constraint=false];
        {rank=same;mip;mid;area}
        
        briseno [label="BriseÃ±o\nclassification"];
        crop -> briseno;
        pulpa [label="Extraction of \npulpa"];
        
        {rank=same;briseno;pulpa;edt}

        apex -> pulpa [constraint=false];
        edt [label="Euclidean distance\ntransformation"];        
        apex -> edt;
        threed [label="3D view"]
        crop -> threed[constraint=false];
        apex -> threed[constraint=false];
        pulpa -> threed -> bmp[constraint=false];
        area [label="Calculation of pulpa area"]
        pulpa -> area;
        apex -> area;
        merge [label="Merged data for manual foramen analysis"]
        pulpa -> merge;
        edt -> merge;
        }
        
    #subgraph cluster_output {
    #    color=grey;
    #    penwidth=2;
    #    
    #    disk [label="Save to disk"];
    #
    #    log -> disk;
    #    area -> disk;
    #    crop -> disk;
    #    mid -> disk;
    #    mip -> disk;        
    #    briseno -> disk;
    #    pulpa -> disk;
    #    edt -> disk;
    #    merge -> disk;
    #    }
}
